# PG Solo-Lite 운영 런북

이 문서는 PG Solo-Lite 시스템의 운영, 유지보수, 장애 대응 절차를 기술합니다.

---

## 1. 운영 런북(요약)

### 1.1. 시스템 가동 및 중지

시스템은 `docker-compose` 또는 `systemd`를 통해 단일 서비스로 관리됩니다.

- **가동 (Docker):**
  ```bash
  docker-compose up -d
  ```
- **중지 (Docker):**
  ```bash
  docker-compose down
  ```
- **가동 (systemd):**
  ```bash
  sudo systemctl start pg-solo-lite.service
  ```
- **중지 (systemd):**
  ```bash
  sudo systemctl stop pg-solo-lite.service
  ```

### 1.2. 알림 워커

시스템은 텔레그램 알림을 위해 데이터베이스 기반의 **아웃박스 패턴**을 사용합니다. 이 방식은 알림 전송을 보장하고 재시도/실패를 안정적으로 관리합니다.

- **작동 원리:**
  1.  애플리케이션 로직은 `notification_outbox` 테이블에 알림 메시지를 `PENDING` 상태로 삽입합니다.
  2.  별도의 알림 워커(Notify Worker)가 주기적으로 `notification_outbox` 테이블에서 `status='PENDING'`인 알림을 조회합니다.
  3.  동시성 문제를 피하기 위해 `SELECT ... FOR UPDATE SKIP LOCKED` 구문을 사용하여 여러 워커가 동일한 알림을 처리하는 것을 방지합니다.
  4.  알림 전송 성공 시, 해당 항목의 `status`를 `SENT`로 업데이트합니다.
  5.  전송 실패 시, `fail_count`를 1 증가시키고 `send_after` 필드에 백오프 시간을 적용하여 재시도를 예약합니다.

- **재시도 정책:**
  - 기본 재시도 간격: **1분 → 2분 → 5분 → 15분 → 30분**
  - **5회 이상** 실패한 알림은 `status`가 `FAILED`로 변경되고, 운영자에게 시스템 경고(CRITICAL)가 발송됩니다.

### 1.3. 백업 및 복구

데이터 무결성을 위해 정기적인 백업과 WAL(Write-Ahead Logging) 아카이빙을 수행합니다.

- **백업 정책:**
  - **전체 백업:** 매일 1회 `pg_dump`를 사용하여 데이터베이스 전체 스냅샷을 생성합니다.
  - **WAL 아카이빙:** Point-in-Time Recovery(PITR)를 위해 WAL 파일을 지속적으로 아카이빙합니다.

- **복구 절차:**
  1.  가장 최근의 전체 백업 파일을 복원합니다.
  2.  장애 발생 시점 직전까지 아카이빙된 WAL 파일을 재생하여 데이터를 복구합니다.
  3.  복구 후, `notification_outbox` 테이블에 `PENDING` 상태로 남아있는 알림은 **안전하게 재전송**될 수 있습니다. `dedupe_key` 유니크 제약 덕분에 이미 전송된 메시지가 중복 발송되는 것을 방지합니다.

### 1.4. 장애 대응

시스템은 내/외부 장애에 대응하기 위한 간단하고 견고한 전략을 내장하고 있습니다.

- **외부 API 장애:**
  - 브로커 API 또는 외부 서비스 호출 실패 시, **지수 백오프(Exponential Backoff)** 재시도 로직이 적용됩니다. 이를 통해 일시적인 네트워크 문제나 API 과부하에 자동으로 대응합니다.

- **내부 예외:**
  - 애플리케이션 내부에서 처리되지 않은 예외 발생 시, 해당 오류는 구조화된 로그로 기록됩니다.
  - 심각도에 따라 `WARN` 또는 `CRITICAL` 등급의 텔레그램 알림이 운영자에게 즉시 발송되어 신속한 개입을 유도합니다.

---

## 부록 A. 전략 기본 원칙(요약)

### A.1. 핵심 원칙

- **계획 후 실행:** 거래 진입 전에 진입, 목표, 무효화(손절) 지점을 명확히 정의합니다.
- **손실은 짧게, 추세는 길게:** 손실 중인 포지션은 신속히 정리하고, 수익 중인 포지션은 추세를 따라갑니다.
- **원금 보존 우선:** 첫 번째 임무는 수익 창출이 아닌 자본 보호입니다.
- **단순함과 일관성:** 복잡한 전략보다 단순하고 꾸준히 실행할 수 있는 전략이 효과적입니다.
- **기록 및 학습:** 모든 거래를 기록하고 복기하여 실수를 통해 배웁니다.
- **현물 우선:** 특히 초기에는 레버리지 없이 현물 시장에서 원리를 익힙니다.

### A.2. 주의사항

- **다이버전스는 힌트일 뿐:** 다이버전스는 추세 전환의 '가능성'을 시사하지만, 그 자체로 진입 신호가 아닙니다. 반드시 지지/저항(S/R) 플립, 추세선 돌파 등 가격의 확인(Price Confirmation)을 기다려야 합니다.

### A.3. 8단계 체크리스트

모든 거래 결정은 다음의 체계적인 단계를 거쳐야 합니다.

1.  **Top-Down 분석:** 주간/일간 차트에서 장기 추세를 먼저 파악합니다.
2.  **핵심 지지/저항(S/R) 영역 식별:** 의미 있는 가격 반응이 있었던 주요 영역을 표시합니다.
3.  **거래량 분석:** 현재 가격 움직임이 충분한 거래량에 의해 뒷받침되는지 확인합니다.
4.  **진입 신호 탐색:** 캔들 패턴, 다이버전스, 차트 패턴 돌파 등 구체적인 진입 근거를 찾습니다.
5.  **신호 확인(Confirmation):** 속임수(Fakeout)를 피하기 위해 리테스트나 시장 구조의 변화를 기다립니다.
6.  **손절 지점 설정:** 진입 근거가 더 이상 유효하지 않게 되는 지점을 명확히 설정합니다.
7.  **포지션 규모(Sizing) 계산:** 리스크 관리 원칙(예: 1-3% 규칙)에 따라 진입 규모를 결정합니다.
8.  **거래 관리:** 진입 후 계획에 따라 부분 익절, 손절매 이동(Trailing Stop) 등을 실행합니다.
